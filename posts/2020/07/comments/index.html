<!DOCTYPE html>
<html lang="en">
<title>Comments via Github issues - The stuff I do</title>

<meta name="description" content="A personal blog where I write about my side projects">
<meta name="robots" content="index,follow">
<meta name="author" content="statox">

<link rel="canonical" href="https://www.statox.fr/posts/2020/07/comments/">

<meta property="og:title" content="Comments via Github issues - The stuff I do">
<meta property="og:type" content="article">

<meta property="og:url" content="https://www.statox.fr/posts/2020/07/comments/">
<meta property="og:description" content="A personal blog where I write about my side projects">


<meta name="twitter:card" content="summary">

<meta name="twitter:url" content="https://www.statox.fr/posts/2020/07/comments/">
<meta name="twitter:title" content="Comments via Github issues - The stuff I do">
<meta name="twitter:description" content="A personal blog where I write about my side projects">



<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Comments via Github issues</title>
    <meta name="description" content="A personal blog where I write about my side projects">
    <meta name="keywords" content="statox blog">
    <meta property="og:title" content="The stuff I do">
    <meta property="og:url" content="https://www.statox.fr">
    <meta property="og:description" content="A personal blog where I write about my side projects">
    <meta property="og:type" content="website">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/open-fonts@1.1.1/fonts/inter.min.css">

    
    
    <style>
      /*!
 * new.css framework forked from https://github.com/xz/new.css
 */:root{--nc-font-sans:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--nc-font-mono:Consolas,monaco,'Ubuntu Mono','Liberation Mono','Courier New',Courier,monospace;--nc-tx-1:#000000;--nc-tx-2:#1A1A1A;--nc-tx-3:#6d7169;--nc-bg-1:#FFFFFF;--nc-bg-2:#F6F8FA;--nc-bg-3:#E5E7EB;--nc-lk-1:#0070F3;--nc-lk-2:#0366D6;--nc-lk-tx:#FFFFFF;--nc-ac-1:#79FFE1;--nc-ac-tx:#0C4047;--nc-d-tx-1:#ffffff;--nc-d-tx-2:#eeeeee;--nc-d-tx-3:#8a8d87;--nc-d-bg-1:#000000;--nc-d-bg-2:#111111;--nc-d-bg-3:#222222;--nc-d-lk-1:#3291FF;--nc-d-lk-2:#0070F3;--nc-d-lk-tx:#FFFFFF;--nc-d-ac-1:#7928CA;--nc-d-ac-tx:#FFFFFF}@media (prefers-color-scheme:dark){:root{--nc-tx-1:var(--nc-d-tx-1);--nc-tx-2:var(--nc-d-tx-2);--nc-bg-1:var(--nc-d-bg-1);--nc-bg-2:var(--nc-d-bg-2);--nc-bg-3:var(--nc-d-bg-3);--nc-lk-1:var(--nc-d-lk-1);--nc-lk-2:var(--nc-d-lk-2);--nc-lk-tx:var(--nc-d-lk-tx);--nc-ac-1:var(--nc-d-ac-1);--nc-ac-tx:var(--nc-d-ac-tx)}}*{margin:0;padding:0}address,area,article,aside,audio,blockquote,datalist,details,dl,fieldset,figure,form,iframe,img,input,meter,nav,ol,optgroup,option,output,p,pre,progress,ruby,section,table,textarea,ul,video{margin-bottom:1rem}button,html,input,select{font-family:var(--nc-font-sans)}body{margin:0 auto;max-width:750px;padding:2rem;border-radius:6px;overflow-x:hidden;word-break:break-word;overflow-wrap:break-word;background:var(--nc-bg-1);color:var(--nc-tx-2);font-size:1.03rem;line-height:1.5}::selection{background:var(--nc-ac-1);color:var(--nc-ac-tx)}h1,h2,h3,h4,h5,h6{line-height:1;color:var(--nc-tx-1);padding-top:.875rem}h1,h2,h3{color:var(--nc-tx-1);padding-bottom:2px;margin-bottom:8px;border-bottom:1px solid var(--nc-bg-2)}h4,h5,h6{margin-bottom:.3rem}h1{font-size:2.25rem}h2{font-size:1.85rem}h3{font-size:1.55rem}h4{font-size:1.25rem}h5{font-size:1rem}h6{font-size:.875rem}a{color:var(--nc-lk-1)}a:hover{color:var(--nc-lk-2)}abbr:hover{cursor:help}blockquote{padding:1.5rem;background:var(--nc-bg-2);border-left:5px solid var(--nc-bg-3)}abbr{cursor:help}blockquote :last-child{padding-bottom:0;margin-bottom:0}header{background:var(--nc-bg-2);border-bottom:1px solid var(--nc-bg-3);padding:2rem 1.5rem;margin:-2rem calc(0px - (50vw - 50%)) 2rem;padding-left:calc(50vw - 50%);padding-right:calc(50vw - 50%)}header h1,header h2,header h3{padding-bottom:0;border-bottom:0}header>:first-child{margin-top:0;padding-top:0}header>:last-child{margin-bottom:0}a button,button,input[type=button],input[type=reset],input[type=submit]{font-size:1rem;display:inline-block;padding:6px 12px;text-align:center;text-decoration:none;white-space:nowrap;background:var(--nc-lk-1);color:var(--nc-lk-tx);border:0;border-radius:4px;box-sizing:border-box;cursor:pointer;color:var(--nc-lk-tx)}a button[disabled],button[disabled],input[type=button][disabled],input[type=reset][disabled],input[type=submit][disabled]{cursor:default;opacity:.5;cursor:not-allowed}.button:enabled:hover,.button:focus,button:enabled:hover,button:focus,input[type=button]:enabled:hover,input[type=button]:focus,input[type=reset]:enabled:hover,input[type=reset]:focus,input[type=submit]:enabled:hover,input[type=submit]:focus{background:var(--nc-lk-2)}code,kbd,pre,samp{font-family:var(--nc-font-mono)}code,kbd,pre,samp{background:var(--nc-bg-2);border:1px solid var(--nc-bg-3);border-radius:4px;padding:3px 6px;font-size:.9em}kbd{border-bottom:3px solid var(--nc-bg-3)}pre{padding:1rem 1.4rem;max-width:100%;overflow:auto}pre code{background:inherit;font-size:inherit;color:inherit;border:0;padding:0;margin:0}code pre{display:inline;background:inherit;font-size:inherit;color:inherit;border:0;padding:0;margin:0}details{padding:.6rem 1rem;background:var(--nc-bg-2);border:1px solid var(--nc-bg-3);border-radius:4px}summary{cursor:pointer;font-weight:700}details[open]{padding-bottom:.75rem}details[open] summary{margin-bottom:6px}details[open]>:last-child{margin-bottom:0}dt{font-weight:700}dd::before{content:'‚Üí '}hr{border:0;border-bottom:1px solid var(--nc-bg-3);margin:1rem auto}fieldset{margin-top:1rem;padding:2rem;border:1px solid var(--nc-bg-3);border-radius:4px}legend{padding:auto .5rem}table{border-collapse:collapse;width:100%}td,th{border:1px solid var(--nc-bg-3);text-align:left;padding:.5rem}th{background:var(--nc-bg-2)}tr:nth-child(even){background:var(--nc-bg-2)}table caption{font-weight:700;margin-bottom:.5rem}textarea{max-width:100%}ol,ul{padding-left:2rem}li{margin-top:.4rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}mark{padding:3px 6px;background:var(--nc-ac-1);color:var(--nc-ac-tx)}input,select,textarea{padding:6px 12px;margin-bottom:.5rem;background:var(--nc-bg-2);color:var(--nc-tx-2);border:1px solid var(--nc-bg-3);border-radius:4px;box-shadow:none;box-sizing:border-box}img{max-width:100%}/*!
 * prism.js tomorrow night eighties for javascript, coffeescript, css and html
 * based on https://github.com/chriskempson/tomorrow-theme
 * Author: Rose Pritchard
 */code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}.post-subheader{font-style:italic;color:var(--nc-tx-3)}.post-date{font-family:var(--nc-font-mono)}@media screen and (max-width:600px){.post-date{display:none}}.formatted-tag{font-family:var(--nc-font-mono);opacity:.6}.not-found{text-align:center}#not-found-canvas{z-index:-1}a{text-decoration:none}pre{max-height:50rem}img{display:block;margin-left:auto;margin-right:auto}ul{list-style-type:circle}/*!
 * Inspired by material theme https://www.material-theme.com/docs/reference/color-palette/
 */:root{--nc-tx-1:#546e7a;--nc-tx-2:#161d21;--nc-tx-3:#6d7169;--nc-bg-1:#F4F4F4;--nc-bg-2:#eae8e8;--nc-bg-3:#FAFAFA;--nc-lk-1:#176166;--nc-lk-2:#528aff;--nc-lk-tx:#F3F4F5;--nc-ac-1:#91B859;--nc-ac-tx:#FAFAFA;--nc-d-tx-1:#FFFFFF;--nc-d-tx-2:#B7B7B7;--nc-d-tx-3:#8a8d87;--nc-d-bg-1:#1E272C;--nc-d-bg-2:#161d21;--nc-d-bg-3:#263238;--nc-d-lk-1:#5E92FF;--nc-d-lk-2:#528aff;--nc-d-lk-tx:#2E3C43;--nc-d-ac-1:#C3E88D;--nc-d-ac-tx:#263238}@media (prefers-color-scheme:dark){:root{--nc-tx-1:var(--nc-d-tx-1);--nc-tx-2:var(--nc-d-tx-2);--nc-tx-3:var(--nc-d-tx-3);--nc-bg-1:var(--nc-d-bg-1);--nc-bg-2:var(--nc-d-bg-2);--nc-bg-3:var(--nc-d-bg-3);--nc-lk-1:var(--nc-d-lk-1);--nc-lk-2:var(--nc-d-lk-2);--nc-lk-tx:var(--nc-d-lk-tx);--nc-ac-1:var(--nc-d-ac-1);--nc-ac-tx:var(--nc-d-ac-tx)}}.nav-link{text-decoration:none}.nav-link.active{color:var(--nc-lk-2)}.hamburger{width:20px;height:2px;box-shadow:inset 0 0 0 32px,0 -6px,0 6px;margin:16px 7px;display:block}.topnav .icon{display:none}@media screen and (max-width:600px){.topnav span.nav-item:not(.active){display:none}.topnav span.icon{float:right;display:block;right:0;top:0;color:var(--nc-lk-1)}}@media screen and (max-width:600px){.topnav .nav-separator{display:none}}@media screen and (max-width:600px){.topnav.responsive{position:relative}.topnav.responsive span.icon{position:absolute;right:0;top:0;color:var(--nc-lk-2)}.topnav.responsive span{float:none;display:block;text-align:left}.topnav.responsive span.nav-item:not(.active){display:block}}.comment{--comment-bg:#e3efee;--comment-d-bg:#2a4765;margin-top:20px;padding:5px}.add-comment-btn{float:right}.comment-header{background:var(--comment-bg);padding-right:100px;padding-left:10px;border-top-left-radius:10px;border-top-right-radius:10px;padding:5px}.comment-content{border:2px solid var(--comment-bg);border-bottom-left-radius:10px;border-bottom-right-radius:10px}.comment-text{padding:10px}.comment-reactions{border-top:2px solid var(--comment-bg);padding:5px}.comment-reaction-item{padding-right:10px;padding-left:10px;border-right:2px solid var(--comment-bg)}@media (prefers-color-scheme:dark){.comment{--comment-bg:var(--comment-d-bg)}}kbd{--black-800:#242729;--white:#fff;--black-075:#e4e6e8;--black-300:#9fa6ad;--s-prose-line-height:1.5;--ff-sans:Arial,"Helvetica Neue",Helvetica,sans-serif}@media (prefers-color-scheme:dark){kbd{--black-800:#e7e8eb;--white:#2d2d2d;--black-075:#404345;--black-300:#7d848d}}kbd{display:inline-block;margin:0 .1em;padding:.1em .6em;font-family:var(--nc-font-sans);font-size:11px;line-height:var(--s-prose-line-height);color:var(--black-800);text-shadow:0 1px 0 var(--white);background-color:var(--black-075);border:1px solid var(--black-300);border-radius:3px;box-shadow:0 1px 1px rgba(12,13,14,.15),inset 0 1px 0 0 #fff;overflow-wrap:break-word}
    </style>

    
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5">

    <script>
        function navbarToggle() {
            var x = document.getElementById("header-navbar");
            if (x.className === "topnav") {
                x.className += " responsive";
            } else {
                x.className = "topnav";
            }
        }
    </script>
</head>
<body>
    <header>
        <h1>The stuff I do</h1>
        <!--
           - Make the whole navbar clickable: It doesn't change anything on desktop
           - and makes it easier to open the menu on mobile
           -->
        <nav class="topnav" id="header-navbar" onclick="navbarToggle()">
            
            
            

            
                
                
                
                
                <span class="nav-item ">
                    <a class="nav-link " href="/">Home</a>
                    <i class="nav-separator"> ‚ô¢ </i>
                </span>
                
                
                
                
                
                <span class="nav-item ">
                    <a class="nav-link " href="/coolcovers/">Cool covers</a>
                    <i class="nav-separator"> ‚ô¢ </i>
                </span>
                
                
                
                
                
                <span class="nav-item ">
                    <a class="nav-link " href="/notes/">Notes</a>
                    <i class="nav-separator"> ‚ô¢ </i>
                </span>
                
                
                
                
                
                <span class="nav-item ">
                    <a class="nav-link " href="/about/">About</a>
                    <i class="nav-separator"> ‚ô¢ </i>
                </span>
                
                
                
                
                
                <span class="nav-item ">
                    <a class="nav-link " href="/social/">Social</a>
                    <i class="nav-separator"> ‚ô¢ </i>
                </span>
                
                
                
                
                
                <span class="nav-item ">
                    <a class="nav-link " href="/ring/">Ring</a>
                    <i class="nav-separator"> ‚ô¢ </i>
                </span>
                
                
                
                
                
                <span class="nav-item ">
                    <a class="nav-link " href="/feed.xml">RSS</a>
                    <i class="nav-separator"></i>
                </span>
                

                
                <span class="icon hamburger" onclick="navbarToggle()"> </span>
        </nav>
    </header>

    

    <div class="content-container">
        
<h2>Comments via Github issues</h2>
<p class="post-subheader">
    <span id="post_date"></span>
    - 1211 words
    - <span id="commentCounter"></span> <span id="comment_word"></span>

</p>
<p><a href="/">‚Üê Posts</a></p>

<p>Recently, a former coworker of mine <a href="https://25.wf/posts/2020-06-21-comments.html" target="_blank" rel="noopener noreferrer">published his solution</a> to implement comments on his personal website via Github issues. I was looking for a solution to add comments on this site and decided to <s>shamelessly copy</s> get inspiration from his post.</p>
<p>So I reformatted a bit his script, added it to my posts and realized that this solution implied to create a new issue on Github each time I created a new post. As I already use <a href="https://travis-ci.com/github/statox/blog" target="_blank" rel="noopener noreferrer">travis-ci</a> to build this website I thought it would be a nice addition to create a script to automatically create these issues for me.</p>
<p>The full source of the script is included in the site repository <a href="https://github.com/statox/blog/blob/master/tools/createIssues.js" target="_blank" rel="noopener noreferrer">here</a>, in this article I will show how I configured everything.</p>
<h3>Overview</h3>
<p>Here are the important steps to make all of this working:</p>
<ul>
<li>Create a dedicated repo <a href="https://github.com/statox/blog-comments/issues" target="_blank" rel="noopener noreferrer">blog-comments</a> which will contain the issues used to host comments;</li>
<li>Have the CI run the script each time a new article is published;</li>
<li>Give the script the ability to create new issues in the blog-comments repo;</li>
<li>Give each post a unique number representing the issue ID on Github. <a href="https://www.11ty.dev/docs/data-cascade/" target="_blank" rel="noopener noreferrer">Eleventy</a> provides a simple way to do that;</li>
<li>Make the script parsing all the published posts, listing the posts without an associated issue and creating the issues;</li>
<li>Change the posts source code to inject the comments.</li>
</ul>
<h3>A quick update</h3>
<p><em>November 2020 -</em> When I originally wrote the script I didn't want to think too much about the authentication to Github API and chose to go the simple way using a login/password basic auth header. This worked well until Github decided to deprecate this authentication mode.</p>
<p>So I replaced the calls made to Github API via axios by the <a href="https://github.com/octokit/rest.js" target="_blank" rel="noopener noreferrer">octokit</a> library. It wraps the calls to the API and it handles the authentication really simply and replacing the axios calls were only a matter of minutes <em>(I take that as a sign that my script was decently architectured üòé)</em>.</p>
<p>The complete version of the script is still <a href="https://github.com/statox/blog/blob/061b79001fda91c7c8b4bb72147247a4e24eff11/tools/createIssues.js" target="_blank" rel="noopener noreferrer">on Github</a>.</p>
<h3>Configuring travis-ci</h3>
<p>Running a script at build time with travis-ci is fairly straight forward. I added a new step in the <code>script</code> job looking like this:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">script</span><span class="token punctuation">:</span><br>  <span class="token punctuation">-</span> npm run create<span class="token punctuation">-</span>issues <span class="token punctuation">-</span><span class="token punctuation">-</span> $BASIC_AUTH_HEADER</code></pre>
<p><code>$BASIC_AUTH_HEADER</code> is a variable which contains the string <code>github_username:github_password</code> encoded in base64. It will be used by the script to authenticate its calls to the Github API <a href="https://developer.github.com/v3/#authentication" target="_blank" rel="noopener noreferrer">using Basic Authentication</a>. Travis has <a href="https://docs.travis-ci.com/user/environment-variables/#defining-variables-in-repository-settings" target="_blank" rel="noopener noreferrer">a simple interface</a> to define this kind of variable. The double dash <code>--</code> is used to give a parameter to a npm script defined in <code>package.json</code>.</p>
<p>In <code>package.json</code> I added a new script like this:</p>
<pre class="language-json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>    <span class="token property">"create-issues"</span><span class="token operator">:</span> <span class="token string">"node tools/createIssues.js"</span><br><span class="token punctuation">}</span></code></pre>
<p>Committing a simple nodejs script at <code>tools/createIssues.js</code> with only a <code>console.log()</code> confirmed this setup is working as the output of the command was shown in the travis build.</p>
<h3>Implementing the CI script</h3>
<p>Using the <a href="https://github.com/axios/axios" target="_blank" rel="noopener noreferrer">axios</a> library I can list the existing issues in the blog-comment repo:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> Axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token constant">BASIC_AUTH_HEADER</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [0] is "node", [1] is scriptname</span><br><br><span class="token comment">/*<br> * Configure axios to always use my user agent and my Github login<br> * to authenticate to the Github API<br> */</span><br><span class="token keyword">const</span> axios <span class="token operator">=</span> Axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>    baseURL<span class="token operator">:</span> <span class="token string">'https://api.github.com/'</span><span class="token punctuation">,</span><br>    headers<span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token string">'User-Agent'</span><span class="token operator">:</span> <span class="token string">'statox'</span><span class="token punctuation">,</span><br>        <span class="token string">'Authorization'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">basic </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">BASIC_AUTH_HEADER</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">/*<br> * Get all of the open issues in a github repo<br> */</span><br><span class="token keyword">function</span> <span class="token function">getIssues</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><br>        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">repos/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">REPO_NAME</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/issues</span><span class="token template-punctuation string">`</span></span><br>    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>data<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>The other items to list are the posts. Here I needed to create a function to recursively list the files in my <code>src/posts</code> directory. These files have a header section delimited by <code>---</code> strings which are used by eleventy (the static site generator I used for this site). I created a function to parse these header and return a javascript object, that was a quick way to get things done without digging the doc but I'm sure there is a more efficient way to get this data out of eleventy. <em>(For example I could write this data directly in JS in the posts files)</em></p>
<p>With this short function I list all my posts, get their title and the ID of the issue I associated to it and exclude the posts I have not published yet.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">/*<br> * Iterate through all the files found in the post folder<br> * Read them to get their data section<br> * And return a list of parsed data sections<br> */</span><br><span class="token keyword">function</span> <span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token function">walkSync</span><span class="token punctuation">(</span><span class="token string">'src/posts/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    async<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token punctuation">{</span>encoding<span class="token operator">:</span> <span class="token string">'utf-8'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br><br>            <span class="token comment">// Only keep the part between the two '---' lines</span><br>            <span class="token keyword">const</span> postHeader <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'---'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><br>            <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">convertPostHeader</span><span class="token punctuation">(</span>postHeader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// Only keep the published posts</span><br>        <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> results<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=></span> p<span class="token punctuation">.</span>eleventyExcludeFromCollections <span class="token operator">!==</span> <span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>A bit more logic to detect the issues which need to be created and an additional call to the Github API and here is our working script:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">/*<br> * Post a new issue on github<br> */</span><br><span class="token keyword">function</span> <span class="token function">createIssue</span><span class="token punctuation">(</span><span class="token parameter">issue<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DRY_RUN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'DRY RUN: creating issue'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>issue<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><br>        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">repos/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">REPO_NAME</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/issues</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <br>        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>            title<span class="token operator">:</span> issue<span class="token punctuation">.</span>title<span class="token punctuation">,</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>data<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>I added a <code>DRY_RUN</code> variable which comes from how I call the script for testing purposes.</p>
<h3>Showing the comments in the posts</h3>
<p>Using the <code>commentIssueId</code> of each post and the following script allows to inject the comments in the comment section:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Script to inject comments based on github issues</span><br><span class="token comment">// Shamelessly taken from https://25.wf/posts/2020-06-21-comments.html</span><br><span class="token keyword">function</span> <span class="token function">domReady</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">'interactive'</span> <span class="token operator">||</span> document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">'complete'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getComments</span><span class="token punctuation">(</span>url <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span><br>        method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span><br>        mode<span class="token operator">:</span> <span class="token string">'cors'</span><span class="token punctuation">,</span><br>        cache<span class="token operator">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">,</span><br>        headers<span class="token operator">:</span> <span class="token punctuation">{</span> Accept<span class="token operator">:</span> <span class="token string">'application/vnd.github.v3.html+json'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token function">domReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> apiUrl <span class="token operator">=</span> <span class="token string">'https://api.github.com/repos/statox/blog-comments/issues/10/comments'</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> <span class="token function-variable function">appendComments</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">comments</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">const</span> commentSection <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'comments'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>comments <span class="token operator">||</span> <span class="token operator">!</span>comments<span class="token punctuation">.</span>forEach <span class="token operator">||</span> comments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            commentSection<span class="token punctuation">.</span><span class="token function">insertAdjacentHTML</span><span class="token punctuation">(</span><span class="token string">'beforeend'</span><span class="token punctuation">,</span> <span class="token string">'&lt;p>No comments yet.&lt;/p>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">return</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        comments<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">comment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            commentSection<span class="token punctuation">.</span><span class="token function">insertAdjacentHTML</span><span class="token punctuation">(</span><br>                <span class="token string">'beforeend'</span><span class="token punctuation">,</span><br>                <span class="token string">'&lt;div class="comment">'</span> <span class="token operator">+</span><br>                <span class="token string">'‚Ä¢ &lt;a href="'</span> <span class="token operator">+</span> comment<span class="token punctuation">.</span>user<span class="token punctuation">.</span>html_url <span class="token operator">+</span> <span class="token string">'" target="_blank">'</span> <span class="token operator">+</span> comment<span class="token punctuation">.</span>user<span class="token punctuation">.</span>login <span class="token operator">+</span> <span class="token string">'&lt;/a>'</span> <span class="token operator">+</span><br>                <span class="token string">' on'</span> <span class="token operator">+</span><br>                <span class="token string">' &lt;a href="'</span> <span class="token operator">+</span> comment<span class="token punctuation">.</span>html_url <span class="token operator">+</span> <span class="token string">'" target="_blank">'</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span>created_at<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUTCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;/a>'</span> <span class="token operator">+</span><br>                comment<span class="token punctuation">.</span>body_html <span class="token operator">+</span><br>                <span class="token string">'&lt;/div>'</span><span class="token punctuation">,</span><br>            <span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token function">getComments</span><span class="token punctuation">(</span>apiUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>appendComments<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3>So much time saved!</h3>
<p>And that's how I came up with a system which makes me save about one minute every time I publish a new post (which doesn't happen more than a few time a month at best)! It took me about 4 hours to get the whole thing working so according to this famous XKCD... that might have been a bit of a waste of time, but it was fun to do! üòÖ</p>
<p><img src="https://imgs.xkcd.com/comics/is_it_worth_the_time.png" alt="XKCD is it worth the time"></p>
<p>I still have a few more things I want to implement:</p>
<ul>
<li>Improving how I handle the data coming from the posts to avoid parsing it myself</li>
<li>Adding a check to make sure my posts all have unique and sequential issues ID</li>
<li>Adding a mechanism to update the title of the issues if the title of the post change</li>
<li>Adding a content to the OP of the issue to have a link to the article</li>
</ul>
<p>But given the previous XKCD graph I'll see when I have time for that and if I really have a need for it too.</p>


<p><a href="/">‚Üê Posts</a></p>



<hr>


<p>
<h3>Related posts</h3>

<p>Posts in the same category: <span class='formatted-tag'>[meta]<span><p>
<ul><li>
            <a class="post-link" href=/posts/2021/03/travis-to-githubactions/>Migrating my CI from Travis-CI to Github Actions</a>
        </li></ul>
<p>



<hr>
<comments>
    <h3>Comments</h3>
    <a class="add-comment-btn" href="https://github.com/statox/blog-comments/issues/10#new_comment_field"  target="_blank" rel="noopener noreferrer">
        <button>Comment on Github</button>
    </a>
    <br>
</comments>

<script type="text/javascript" src="/scripts/githubComments.js"></script>
<script type="text/javascript">
setupCommentsInPage(10);

/* Use a media query to change the content of the interface for smaller screens */
function adaptToScreenSize(x) {
    const postDate = new Date('Tue Jul 14 2020 00:00:00 GMT+0000 (Coordinated Universal Time)');

    let datePostContent = postDate.toLocaleDateString(undefined,  { year: 'numeric', month: 'long', day: 'numeric' });
    let commentWordSpanContent = 'comments';

    if (x.matches) { // Small screens
        datePostContent = postDate.toLocaleDateString(undefined,  { year: 'numeric', month: 'numeric', day: 'numeric' });
        commentWordSpanContent = 'üí¨';
    }

    document.getElementById('post_date').textContent = datePostContent;
    document.getElementById('comment_word').textContent = commentWordSpanContent;
}

var x = window.matchMedia("(max-width: 700px)")
adaptToScreenSize(x) // Call listener function at run time
x.addListener(adaptToScreenSize) // Attach listener function on state changes 
</script>

    </div>

    <script data-goatcounter="https://statoxblog.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
